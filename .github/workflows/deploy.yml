name: Deploy

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Deploy to main branch
      run: |
        repo_path="/home/ubuntu/CICD_GitActions"
        staging_branch="staging"
        main_branch="main"

        cd "$repo_path"
        sudo git config pull.rebase true
        sudo git fetch origin "$staging_branch"
        sudo git pull --rebase origin "$staging_branch"

        sudo git rebase "origin/$staging_branch"
        sudo git config pull.rebase true

        if [[ $(git status | grep 'modified:' | wc -l) -ne 0 ]]; then
          sudo apt update
          sudo apt install -y python3-pip
          sudo pip install -r requirements.txt

          nohup python app.py &&
          pytest test_app.py

          git add .
          git commit -m "Code is modified"
          git push origin "$staging_branch":"$main_branch" --force-with-lease

          echo "Changes pushed to $main_branch branch."
        else
          echo "No code changes detected. Skipping deployment."
        fi
